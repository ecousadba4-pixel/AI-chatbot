# Деплой на Render

Эта директория содержит минимальные файлы, необходимые для подготовки отдельной ветки/сервиса на Render.

## Что входит

- `render.yaml` — инфраструктурный манифест Render, который разворачивает Docker-контейнер из текущего репозитория.
  - Значения `qdrant.example.com` и `redis.example.com` нужно заменить на реальные публичные хосты ваших Qdrant и Redis.
  - Секреты `QDRANT_API_KEY`, `AMVERA_GPT_MODEL`, `AMVERA_GPT_TOKEN` помечены как `sync: false`, поэтому их нужно добавить вручную через панель Render.
- `.env.render.example` — пример файла с переменными окружения, который можно использовать как подсказку при заполнении панели Render.

## Как использовать

1. Создайте новую ветку от `main` (например, `render-deploy`), сохранив в ней **весь проект** вместе с `Dockerfile` и исходниками. Дополнительно можно скопировать файлы из этой директории в корень ветки, если хотите держать конфигурацию рядом с кодом.
2. Если используете Render Blueprint, разместите `render.yaml` в корне ветки или укажите в настройках Blueprint **Root Directory** = `deploy/render` — манифест уже настроен на сборку Docker-образа из корня репозитория (`dockerContext: ..`).
3. Внесите правки в `render.yaml`: укажите реальные URL сервисов, нужный регион и лимиты.
4. В интерфейсе Render выберите **New → Blueprint** (или **New → Web Service** для ручной настройки), подключите ветку и подтвердите деплой.
5. После создания сервиса настройте переменные окружения и секреты в разделе **Environment**.
6. Приложение будет слушать порт из переменной `PORT`, который Render пробрасывает автоматически.

## Настройка переменных окружения

Для удалённых Qdrant и Redis необходимо задать:

- `QDRANT_HOST`, `QDRANT_PORT`, `QDRANT_HTTPS`, `QDRANT_API_KEY`
- `REDIS_HOST`, `REDIS_PORT`

Все остальные переменные соответствуют конфигурации Amvera и уже используются в приложении (`config.py`).

## Проверка

После деплоя убедитесь, что `/health` возвращает статус 200, а приложение успешно подключается к внешним Qdrant и Redis. Если соединение не устанавливается, проверьте, что в Render разрешён исходящий трафик к этим сервисам и заданы корректные креды.

## Типичные ошибки и их исправление

- **Build log: `failed to read dockerfile: open Dockerfile: no such file or directory`.** Значит, в ветке или директории, из которой Render собирает образ, отсутствует `Dockerfile`. Убедитесь, что ветка создана от `main` и содержит весь проект, либо что в настройках Blueprint/Web Service в поле **Root Directory** выбран корневой каталог репозитория.
