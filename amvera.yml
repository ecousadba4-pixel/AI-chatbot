---
version: 2.0

meta:
  environment: docker

toolchain:
  name: docker
  version: latest

build:
  dockerfile: Dockerfile

run:
  containerPort: 8000

  healthCheck:
    path: /health
    intervalSeconds: 15
    timeoutSeconds: 5
    healthyThreshold: 2
    unhealthyThreshold: 3

  resources:
    cpu: "1"
    memory: "1Gi"

  replicas: 1
  autoscaling:
    enabled: false

  env:
    # --- Qdrant (внутренний сервис Amvera) ---
    QDRANT_HOST: "amvera-karinausadba-run-u4s-ai-chatbot"
    QDRANT_PORT: "6333"
    QDRANT_HTTPS: "false"
    QDRANT_API_KEY: "${QDRANT_API_KEY}"   # если не нужен — оставь пустым в панели
    QDRANT_COLLECTION: "hotel_knowledge"

    # --- Redis (внутренний сервис Amvera, пароль не требуется) ---
    REDIS_HOST: "amvera-karinausadba-run-hotelbot-redis"
    REDIS_PORT: "6379"

    # --- Amvera GPT (твой шлюз) ---
    AMVERA_GPT_URL: "https://kong-proxy.yc.amvera.ru/api/v1/models/gpt"
    AMVERA_GPT_TOKEN: "${AMVERA_GPT_TOKEN}"
    AMVERA_GPT_MODEL: "${AMVERA_GPT_MODEL}"

    # --- Shelter PMS ---
    SHELTER_TOKEN: "${SHELTER_TOKEN}"

    # --- Прочее ---
    COLLECTIONS_JSON: '["hotel_knowledge"]'
    GUNICORN_WORKERS: "2"
    PORT: "8000"

    # Стабильность CPU/библиотек в контейнере
    OMP_NUM_THREADS: "1"
    MKL_NUM_THREADS: "1"
    TOKENIZERS_PARALLELISM: "false"
    EMBEDDING_MODEL_NAME: "d0rj/e5-base-en-ru"

  secrets:
    - name: QDRANT_API_KEY
    - name: AMVERA_GPT_TOKEN
    - name: SHELTER_TOKEN
